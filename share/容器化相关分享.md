# 分享主题
* fs -> unionFs -> docker -> container 的本质
* Rancher -> k8s -> Pod -> Pods的实现 
* 为什么要容器化
* 以后应用开发需要注意哪些问题
* 公司未来发布模式的展望
* Legends 针对未来发布的一些改造

# FS -> Union mount -> UnionFS
## Union mount 
联合挂载是指把多个不同的目录(directory)，合并成一个。  
Union mount 是接口层，定义了 Union mount 需要实现的功能，具体的实现比如 linux 早期的 union mount，plan9 等。

## UnionFS (Union File System)

Linux： Inheriting File System  -> UnionFS  
允许多个单独的文件系统的目录，透明的**覆盖**在一起，形成一个联合的文件系统。在合并之后的目录之中，能够看到所有子文件系统的内容。

### UnionFS的一些问题
* 同名文件  
    
    在合并子文件系统的时候，多个文件系统之间，存在**优先级**，所以，如果多个文件系统在同一个目录下，存在一个相同的文件名，则在合并之后的文件系统里面，看到的是，优先级高的那个文件系统的文件。 
    
* 如何创建/删除文件  

    由于合并的子文件系统，可能是Read-Only / Read-Write 的文件系统，所以为了对虚拟合并副本的写入，会将这一类操作定向到一个**新的可写文件系统**。对这个可写文件系统的操作，不会去修改底层的子文件系统，这里一般采用 Copy-on-Write 技术（只有真正发生写操作的时候，才会去创建这一可写层）。

# Docker
![Docker](ref/docker_architech.jpg)

## Docker Image
镜像分层技术
## Docker Container


# 容器编排技术
## kubernetes(k8s)
## Rancher => k3s


# 容器化
## 解决了哪些问题?

# 系统开发需要注意哪些问题?

# 应用发布的六种策略
原文参考: [Six Strategies for Application Deployment](https://thenewstack.io/deployment-strategies)

## Recreated 重建
完全停掉版本A，发布版本B
![recreate](ref/recreate.gif)

#### 优点
* 操作简单

#### 缺点
* 需要停服，用户体验太差

## Ramped 灰度发布(也叫滚动升级 or 增量发布)
对集群中的多台机器，分批发布，直到所有机器容器全部完成升级

#### 优点
* 操作简单 (容器化之后操作简单)
* 对于有状态的应用，能够友好的保持应用状态。

#### 缺点
* 发布与回滚的时间较长
* 对于请求流量不可控
* 对于一些 http 接口，很难做到向下版本兼容

## Blue/Green 蓝绿发布
操作步骤：
1. 同时部署两个完全相互隔离的集群A，集群B，
2. 集群B从对外流量中剥离之后，升级到新版本
3. 测试无误之后，将请求流量切换到集群B
4. 升级集群A
5. A升级完之后，在平均分配流量到AB集群

#### 优点
* 瞬间升级/瞬间回滚（对于请求来说）
* 避免版本升级时的兼容性问题，相互依赖问题等
#### 缺点
* 需要双份的机器资源
* 需要在投入生产之前，对整个平台进行适当的测试
* 很难处理一些有状态的服务（Stateful application）

## Canary 金丝雀
版本B与版本A同时对外提供服务，一开始A承担90%的流量 B承担10%的流量，再B确认无误之后，再主键扩大B的比例，直到100%
流量分配策略一般基于权重实现。

#### 优点
* 能够实现部分用户升级
* 对于控制异常比例，性能监控 较为方便
* 快速回滚
#### 缺点
* 回滚较慢
* 难以处理一些连续的有逻辑顺序的HTTP请求

## A/B testing
根据请求条件，将用户请求路由到指定的集群中。不是基于硬件网络的实现，需要软件代码的支持，针对不同的业务情况，实现起来也较为复杂
常见的方式：白名单/客户端版本号等

#### 优点
* 多版本并行运行
* 流量控制方便
#### 缺点
* 需要更智能的路由策略 
* 对于指定session的异常定位，分布式链路追踪等功能变得难以处理

## Shadow 影子
将版本A的请求，转发一份给版本B，版本B只接受请求，不做任何响应

#### 优点
* 便于做新功能的压力测试
* 对用户无影响
#### 缺点
* 两份机器资源消耗
* 实现起来较为复杂
* 不适用于一些非查询类的接口，比如扣款等


# 公司现在以及未来的模式
## 现在的发布模式
* 切流发布 => Blue/Green
* 灰度发布
## 存在的问题
* 195环境资源浪费
* KVM技术对机器资源的利用率不高  64/256
## 下一版发布模式（也可能是其他方案，还没有确定） 

# Legends针对未来发布模式的一些定制化改造

Legends 参考文档：
  
Legends 接入手册
Legends 使用说明 



